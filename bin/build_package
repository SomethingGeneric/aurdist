#!/bin/bash
set -euo pipefail

# Source the configuration file
source config/aurdist.conf

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <package_name>"
    exit 1
fi

PACKAGE_NAME=$1

echo "Building package: $PACKAGE_NAME"

# Create a temporary directory for the build
BUILD_DIR=$(mktemp -d)

# Start an Arch Linux container
podman run --rm --userns=keep-id -v "$BUILD_DIR:/build" -v "$PWD/repo:/repo" -e "DB_NAME=$DB_NAME" archlinux/archlinux:latest bash -c "
    set -euo pipefail

    # Install build dependencies
    pacman -Syu --noconfirm base-devel git

    # Clone the AUR repository
    git clone https://aur.archlinux.org/$PACKAGE_NAME.git /build/$PACKAGE_NAME

    # Build the package
    cd /build/$PACKAGE_NAME
    makepkg -si --noconfirm

    # Copy the built package to the repo directory
    cp *.pkg.tar.zst /repo/

    # Update the repository database
        # Update the repository database
    repo-add /repo/${DB_NAME} /repo/*.pkg.tar.zst
"

# Clean up the temporary directory
rm -rf "$BUILD_DIR"

echo "Package built and repository updated."
